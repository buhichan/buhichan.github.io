

# 事务

## ACID 
- atomicity 提交的操作队列要么全部完成, 要么全部没有执行
- consistency 事务前后, 数据库的业务约束条件不变
    - 一致性, ACID的优先级最高者
    - 最终一致性的概念
- isolation 事务执行过程中不会对其他事务产生影响 
    - 隔离级别的概念
- durability 事务执行结束后, 其结果必须被持久化, 事务结束后的系统宕机不会影响其完整性

## 隔离级别

Mysql: (默认为可重复读)

| 事务隔离级别  |	脏读    |	不可重复读  |	幻读    |
|---    |---    |---    |---    |
|读未提交（read-uncommitted）|	是|	是|	是|
|不可重复读（read-committed）|	否|	是|	是|
|可重复读（repeatable-read）|	否|	否|	是|
|串行化（serializable）|	否|	否|	否|


redis事务
有2种实现方式

1. eval
    - pros: 节省带宽和rtt
    - cons: eval会阻塞redis的其余所有执行, 即使是并非在事务中涉及到的key
2. multi/watch/unwatch/exec/discard
    - pros


# 高并发

## 乐观锁 (Compare And Swap)

- redis中watch就是表示这个 (watch A)
- 好处是不会阻塞资源的获取

1. 读取并记录参数A的值
2. 执行事务
3. 读取现在的参数A, 如果其等于A的旧值, 则提交事务, 否则回滚

**问题**

- ABA: 事务T watch了A, A被+1, 然后又被-1, 则在T提交的时候, 会认为可以提交, 实际不能
    - 解决方案: A只能递增
- 由于并发中只有一个事务能完成提交, 所以可以增加重入功能
    - 解决方案: 事务自动/手动重入, 但是自动重入需要有超时机制


# 分布式系统
